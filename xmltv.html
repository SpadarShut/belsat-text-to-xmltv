<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>XMLTV generator</title>
    <script src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
    <style>
        html {
            font: 14px/1.4 sans-serif;
            padding: 0;
            margin: 0;
            height: 100%;
            overflow: hidden;
        }
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
        }
        @-moz-document url-prefix() {
            body {
                width: 100%;
                box-sizing: border-box;
            }
        }
        textarea {
            font: inherit;
            resize: none;
        }
        * {
            box-sizing: border-box;
        }


        #dl {
            color: #fff;
            display: inline-block;
            text-decoration: none;
            background: #2db5d7;
            padding: .5em 2em;
            float: right;
            clear: both;
            border-radius: 3px;
            font-size: 18px;
        }

        #dl:hover {
            background: #35aaca;
        }

        .header {
            padding: 1em;
            flex: 0 0 auto;
        }
        .header__p1 {
            float: left;
        }
        .row {
            margin-bottom: .5em;
        }
        .row-group {
            display: inline-block;
            border: 0;
            padding: 0;
        }
        .row-group + .row-group {
            margin-left: 1em;
        }
        .header__p2 {
            float: right;
        }
        .view-main {
            clear: both;
            background: #eee;
            position: relative;
            flex: 1 1 100%;
        }
        #source {
            width: 50%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            font-family: sans-serif;
            padding: 1em 0 1em 1em;
            border: 1px solid #ccc;
            box-shadow: inset 1px 1px 4px rgba(0,0,0,.1);
        }
        #preview {
            width: 50%;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            overflow: auto;
            font-family: sans-serif;
            border: 1px solid #ccc;
            border-left-width: 0;
            padding: 1em;
            background: #fefdf1;

            order: 0;
            flex: 0 1 50%;
            align-self: auto;
        }
        #preview:empty:before {
            content: 'Тут будзе прагляд выніку';
            margin-left: 1em;
            color: #cccccc;

        }
        programme {
            display: block;
        }
        programme:before {
            content: '<programme start="' attr(start) '" stop="' attr(stop) '\">';
        }
        programme:after {
            content: '</programme>';
        }
        tv title {
            display: block;
        }
        desc {
            display: block;
            margin-left: 1em;
        }
        channel {
            display: none;
        }
        .time {
            background: rgb(245, 245, 192);
            display: inline-block;
            padding: 2px;
        }
        .time-date {
            font-size: 70%;
            color: #666;
        }
        .day {
            font-weight: bold;
            padding:  0 0 .3em 0;
            font-size: 115%;
        }
        .prog +.day {
            margin-top: 1em;
        }
        .desc {
            margin: 0.5em 0 1em 2em;
            font-size: 85%;
            color: #666
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header__p1">
        <div class="row">
            <label class="row-group"><input type="checkbox" id="autoscroll"/> Аўтагартанне</label>
        </div>
        <button class="btn" id="clear-source">Ачысціць тэкст</button>
    </div>
    <div class="header__p2">
        <a href="" class="btn" download="belsat.xml" id="dl" target="_blank"> Спампаваць xml </a>
    </div>
</div>
<div class="view-main">
    <textarea placeholder="Тэкст праграмы перадач" id="source" cols="30" rows="10" autofocus></textarea>
    <div id="preview"></div>
</div>
<script>

    $(function(){
        var iconAddress = 'https://dl.dropboxusercontent.com/u/12866640/belsat-logo.png';
        var rxDay =  /((?:\n|^)(?:\s)?\d{1,2}\.\d\d\.\d{4},?[\s\S]+?(?=\n\d{1,2}\.\d\d\.\d{4}|$))/g;
        var rxProg = /(?:\n|^)(\d{1,2}):(\d\d)(\s*?-\s*?(\d{1,2}):(\d\d))?(.*)([\s\S]*?((?=\n\d\d?:\d\d)|$))/g;
        var rxDate = /(\d{1,2})\.(\d\d)\.(\d{4}),?\s?([\wа-яА-ЯіІўЎёЁ']*)/;

        var $preview = $('#preview');
        var $source = $('#source');
        var $autoscroll = $('#autoscroll');
        var schedule = [];
        var daysFound = 0;

        var escape = function(string) {
            var htmlEscapes = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#x27;',
                '/': '&#x2F;'
            };
            var htmlEscaper = /[&<>"'\/]/g;
            return ('' + string).replace(htmlEscaper, function(match) {
                return htmlEscapes[match];
            });
        };

        function zeroPad (int){
            if (int > 9) {
                return int;
            }
            var i = int.toString(16);
            var ipad = '00' + i;
            var res = ipad.slice(-2);
            return res;
        }

        function getDays(text) {
            // trim leading spaces
            text = text.replace(/\n\s*/g, '\n');
            text = text.replace(/\n\s*/g, '\n');
            var days = text.match(rxDay);
            if(!days) {
                alert('He ўдалося падзяліць на дні');
            }
            daysFound = days;
            return days;
        }

        // extract programs from day
        function getPrograms(day) {
            var progs = [];
            day = day.trim();
            var date  = rxDate.exec(day);
            if(!date) {
                alert('Немагчыма знайсці дату ў тэксце:\n '+ day.substring(0, 50) + '...');
                return
            }

            var d = zeroPad(date[1]);
            var m = date[2];
            var y = date[3];
            var dw = date[4];

            // find all programs
            while ((prog = rxProg.exec(day)) !== null) {
                var descr = '';
                var h = zeroPad(prog[1]);
                var min = prog[2];
                var s = '00';
                var progObj = {};
                prog[0] = prog[0].trim();

                // get description
                if (prog[0].indexOf('\n') > -1){
                    descr = escape(prog[0].substring(prog[0].indexOf('\n')).trim());
                }
                progObj.title = escape(prog[6]);
                progObj.src = escape(prog[0]);
                progObj.start = { y:y, m:m, d:d, h:h, min:min, s:s, dw:dw };

                // if end time was present set it
                if (prog[4] && prog[5]){
                    prog[4] = zeroPad(prog[4]);
                    progObj.stop = { h: prog[4], min: zeroPad(prog[5]), s:s }
                }

                if (descr) {
                    progObj.description = descr;
                }
                progs.push(progObj);
            }

            // Set stop value to be the same as start value of the next programme.
            // For the last programme just set stop to an hour after start
            for (var i=0; i < progs.length; i++) {
                var start = progs[i].start;
                var stop = progs[i].stop = progs[i].stop || {};
                var isLastProgInDay = i == progs.length-1;
                var startDate = new Date( start.y, start.m-1, start.d, start.h, start.min );
                var stopDate  = new Date( start.y, start.m-1, start.d, 'h' in stop ? stop.h : start.h, 'min' in stop ? stop.min : start.min );

                // adjust start date for progs after 0:00
                if (start.h < 6) {
                    startDate.setDate(1 + parseInt(start.d) )
                }

                // set stop date
                // if stop was not set at all
                if (stop.h === undefined) {
                    // and it's the last prog, add one hour
                    if (isLastProgInDay) {
                        stopDate.setHours(parseInt(start.h) + 1);
                    }
                    // else set end time to start of the next prog
                    else {
                        stopDate.setHours(progs[i+1].start.h);
                        stopDate.setMinutes(progs[i+1].start.min);
                    }
                }

                if ( stopDate.getHours() < 6 ) {
                    stopDate.setDate(1 + parseInt(start.d) );
                }
                progs[i].startDate = startDate;
                progs[i].stopDate = stopDate;
            }
            return progs;
        }

        function buildXMLTV(schedule) {
            var name = '<display-name lang="be">Белсат</display-name>';
            var docTpl = '\
<tv generator-info-name="Белсат" generator-info-url="http://belsat.eu">\
    <channel id="eu.belsat">' +
    name +
    '<icon src="'+ iconAddress +'"/>\
    </channel>\
</tv>\
';
            var $doc = $(docTpl);
            $.each(schedule, function(i, prog){
                var node = buildProgNode(prog);
//                console.log(node.attr('start') + ' ' + node.attr('stop') + " "+ node.text().substring(0,30));
                $doc.append(node);
            });
            return $doc;

        }

        function makeFile(){
            var xml = buildXMLTV(schedule);
            var txt = xml[0].outerHTML;
            return 'data:text/xml,'+
                     encodeURIComponent('\uFEFF<?xml version="1.0" encoding="utf-8" ?>\n<!DOCTYPE tv SYSTEM "http://www.teleguide.info/xmltv.dtd">\n') +
                     encodeURIComponent(txt);

        }

        function buildProgNode(data) {
            var $prog = $('<programme>');
            var utc = ' +0300';
            var strD = data.startDate;
            var stpD = data.stopDate;

            var start = [ strD.getFullYear(), zeroPad(strD.getMonth()+1), zeroPad(strD.getDate()), zeroPad(strD.getHours()), zeroPad(strD.getMinutes()), '00', utc].join('');
            var stop = [ stpD.getFullYear(), zeroPad(stpD.getMonth()+1), zeroPad(stpD.getDate()), zeroPad(stpD.getHours()), zeroPad(stpD.getMinutes()), '00', utc].join('');
            $prog.attr('start', start)
                 .attr('stop', stop)
                 .attr('channel', 'eu.belsat')
                 .append($('<title lang="be">'+ data.title +'</title>'));

            if(data.description) {
                $prog.append($('<desc lang="be">'+ data.description +'</desc>'));
            }
            return $prog;
        }

        function buildPreview (schedule){
            var yesterday = schedule[0].start.d;
            var output = '';
            $.each(schedule, function(i, prog){
                // display day and date before each new day
                if ((parseInt(prog.start.d) > yesterday && parseInt(prog.start.h) >= 7) ||
                    (parseInt(prog.start.d) == 1 && yesterday >= 28 ) ||
                     i == 0) {
                    yesterday = prog.start.d;
                    output += '<div class=day>'+ prog.start.d + '.'+ prog.start.m + ' ' +prog.start.dw + '</div>'
                }
                output += buildProgPreview(prog);
            });
            return output;
        }

        function buildProgPreview (prog){
            var strD = prog.startDate;
            var stpD = prog.stopDate;
            var markup = '<div class=prog>' +
                    '<span class="time time-start">'+ zeroPad(strD.getHours()) + ':' + zeroPad(strD.getMinutes()) +
                        ' <span class="time-date">' + [strD.getFullYear(), zeroPad(strD.getMonth()+1), zeroPad(strD.getDate())].join('&middot;') +'</span></span>' +

                 ' - <span class="time time-end">'+ zeroPad(stpD.getHours()) + ':' + zeroPad(stpD.getMinutes()) +
                        ' <span class="time-date">' + [stpD.getFullYear(), zeroPad(stpD.getMonth()+1), zeroPad(stpD.getDate())].join('&middot;') +'</span></span> ' +

                    '<span class=ttl>'+ prog.title + '</span>';

            if (prog.description) {
                markup += '<p class=desc>'+ prog.description + '</p>';
            }
            markup += '</div>';

            return markup;
        }

        function updateView (text) {
            $preview[0].innerHTML = '';
            //debugger;
            $preview.html(text);
        }

        function syncScroll($els) {
            var active;
            var bindScroll;
            var sync = function(e){
                clearTimeout(bindScroll);
                if ( !$autoscroll.is(':checked')) { return; }
                var $other = $els.not(active).off('scroll'), other = $other.get(0);
                var percentage = this.scrollTop / (this.scrollHeight - this.offsetHeight);
                other.scrollTop = percentage * (other.scrollHeight - other.offsetHeight);
                // Firefox workaround. Rebinding without delay isn't enough.
                bindScroll = setTimeout( function(){ $other.on('scroll', sync ); },50);
            };

            $els.on ('mouseenter', function () {
                active = this;
            });
            $els.on( 'scroll', sync);
        }

        $('#clear-source').on('click', function(){
            if(confirm('Ачысціць тэкст?')) {
                $source.val('').trigger('input')
            }
        });

        $source.on('input', function(){
            //console.log('new value');

            if(!this.value.trim()) {
                updateView('');
                return;
            }

            var days = getDays(this.value);

            //console.dir(days);
            schedule = []; //reset
            $.each(days, function(i, day){
                $.each(getPrograms(day), function(i, el){
                    schedule.push(el);
                })
            });

            var schedulePreview = buildPreview(schedule);

            syncScroll($('#preview, #source'));
            updateView( schedulePreview );
        });

        $('#dl').on('click', function(e){
            $(this).attr('href', makeFile());
        });

        $source.trigger('input');
    })
</script>
<!--
    28.03.2016 ПАНЯДЗЕЛАК Белсат TV
    07:00 ПраСвет (інфармацыйна-публіцыстычная праграма)
    07:35 Зона «Свабоды» (аналітычная праграма). Погляд на падзеі тыдня вачыма журналістаў радыё «Свабода»
    08:10 Форум (ток-шоу): Закладнікі
    -->
</body>
</html>